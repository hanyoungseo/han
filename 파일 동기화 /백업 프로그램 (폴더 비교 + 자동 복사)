import os
import shutil
import hashlib
import time

def file_hash(filepath):
    hasher = hashlib.sha256()
    with open(filepath, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hasher.update(chunk)
    return hasher.hexdigest()

def sync_folders(src, dst, interval=5):
    print(f"ğŸ“ Watching for changes...\nSRC: {src}\nDST: {dst}\n")
    os.makedirs(dst, exist_ok=True)
    
    prev_state = {}

    while True:
        current_state = {}

        # ìŠ¤ìº”
        for root, _, files in os.walk(src):
            for file in files:
                src_path = os.path.join(root, file)
                rel_path = os.path.relpath(src_path, src)
                hash_val = file_hash(src_path)
                current_state[rel_path] = hash_val

                # ì‹ ê·œ ë˜ëŠ” ë³€ê²½
                if rel_path not in prev_state or prev_state[rel_path] != hash_val:
                    dst_path = os.path.join(dst, rel_path)
                    os.makedirs(os.path.dirname(dst_path), exist_ok=True)
                    shutil.copy2(src_path, dst_path)
                    print(f"[SYNC] Copied/Updated: {rel_path}")

        # ì‚­ì œëœ íŒŒì¼ ì²˜ë¦¬
        for rel_path in list(prev_state.keys()):
            if rel_path not in current_state:
                dst_path = os.path.join(dst, rel_path)
                if os.path.exists(dst_path):
                    os.remove(dst_path)
                print(f"[REMOVE] Deleted: {rel_path}")

        prev_state = current_state
        time.sleep(interval)

if __name__ == "__main__":
    src = input("Source folder: ")
    dst = input("Backup folder: ")
    sync_folders(src, dst)
